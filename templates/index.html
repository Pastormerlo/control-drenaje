<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Drenaje</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .color-izq { color: #0d6efd; font-weight: bold; }
        .color-der { color: #dc3545; font-weight: bold; }
        .card-grafico { height: 350px; }
        .badge-user { background-color: #f8f9fa; color: #6c757d; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; border: 1px solid #dee2e6; }
    </style>
</head>
<body class="bg-light">
<div class="container py-3">
    <h3 class="text-center mb-3">ü©∫ Control de Drenaje</h3>

    <form method="POST" action="/" class="card p-3 mb-4 shadow-sm" id="drainForm">
        <div class="row g-2">
            <div class="col-6">
                <label class="form-label small">Fecha</label>
                <input type="date" name="fecha" id="f_auto" class="form-control" required>
            </div>
            <div class="col-6">
                <label class="form-label small">Hora</label>
                <input type="time" name="hora" id="h_auto" class="form-control" required>
            </div>
        </div>
        <label class="form-label mt-2 small">üë§ Responsable:</label>
        <input type="text" name="quien" id="quien_input" class="form-control" required>
        
        <label class="form-label mt-2 small">üíß Izquierdo (ml)</label>
        <input type="number" name="cantidad_izq" step="0.01" class="form-control" required>
        
        <label class="form-label mt-2 small">üíß Derecho (ml)</label>
        <input type="number" name="cantidad_der" step="0.01" required class="form-control">

        <label class="form-label mt-2 small">Observaciones</label>
        <textarea name="observaciones" class="form-control" rows="2"></textarea>
        
        <button type="submit" class="btn btn-primary mt-3 w-100 fw-bold">GUARDAR REGISTRO</button>
    </form>

    <div class="card mb-4 shadow-sm p-2 card-grafico">
        <h6 class="text-center text-muted small">Tendencia de Drenaje (ml)</h6>
        <canvas id="graficoLineas"></canvas>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">üìã Historial</h5>
        <button onclick="exportarExcel()" class="btn btn-success btn-sm fw-bold">üìä Excel</button>
    </div>

    <div class="list-group mb-5">
        {% for r in registros %}
        <div class="list-group-item shadow-sm mb-1 rounded">
            <div class="d-flex justify-content-between">
                <span class="small text-muted">{{ r.fecha }} ‚Äî {{ r.hora }}</span>
                <a href="/borrar/{{ r.id }}" class="text-danger fw-bold text-decoration-none" onclick="return confirm('¬øBorrar?')">‚úñ</a>
            </div>
            <div class="mt-1">
                <span class="color-izq">I: {{ r.cant_izq }} ml</span> 
                <span class="text-muted mx-1">|</span> 
                <span class="color-der">D: {{ r.cant_der }} ml</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-secondary">{% if r.observaciones %}{{ r.observaciones }}{% endif %}</small>
                <span class="badge-user">üë§ {{ r.quien }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
    window.onload = function() {
        const ahora = new Date();
        document.getElementById('f_auto').value = ahora.toISOString().split('T')[0];
        document.getElementById('h_auto').value = ahora.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        const uNom = localStorage.getItem('uNom');
        if (uNom) document.getElementById('quien_input').value = uNom;
    }

    document.getElementById('drainForm').onsubmit = function() {
        localStorage.setItem('uNom', document.getElementById('quien_input').value);
    };

    const etiquetas = [{% for r in registros|reverse %}"{{ r.fecha }} {{ r.hora }}"{% if not loop.last %}, {% endif %}{% endfor %}].slice(-10);
    const dIzq = [{% for r in registros|reverse %}{{ r.cant_izq }}{% if not loop.last %}, {% endif %}{% endfor %}].slice(-10);
    const dDer = [{% for r in registros|reverse %}{{ r.cant_der }}{% if not loop.last %}, {% endif %}{% endfor %}].slice(-10);

    new Chart(document.getElementById('graficoLineas'), {
        type: 'line', // CAMBIO A L√çNEAS
        data: {
            labels: etiquetas,
            datasets: [
                { 
                    label: 'Izquierdo', 
                    data: dIzq, 
                    borderColor: '#0d6efd', 
                    backgroundColor: '#0d6efd',
                    tension: 0.3, // Suaviza la l√≠nea
                    fill: false 
                },
                { 
                    label: 'Derecho', 
                    data: dDer, 
                    borderColor: '#dc3545', 
                    backgroundColor: '#dc3545',
                    tension: 0.3, 
                    fill: false 
                }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { 
                y: { beginAtZero: true, title: { display: true, text: 'ml' } },
                x: { ticks: { display: false } } // Ocultamos fechas largas para que no se amontonen
            }
        }
    });

    function exportarExcel() {
        const datos = [["Fecha", "Hora", "Responsable", "Izq (ml)", "Der (ml)", "Observaciones"]];
        {% for r in registros %}
        datos.push(["{{ r.fecha }}", "{{ r.hora }}", "{{ r.quien }}", {{ r.cant_izq }}, {{ r.cant_der }}, "{{ r.observaciones }}"]);
        {% endfor %}
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(datos);
        XLSX.utils.book_append_sheet(wb, ws, "Drenajes");
        XLSX.writeFile(wb, "Control_Drenaje_Bully.xlsx");
    }
</script>
</body>
</html>