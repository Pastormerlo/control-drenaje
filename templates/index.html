<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salud - Mauro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border:none; }
        .seccion-oculta { display: none; }
        canvas { max-height: 250px; width: 100% !important; }
        h6 { font-weight: bold; color: #444; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand">Mauro Salud</span>
        <div class="ms-auto">
            <a class="nav-link text-white d-inline me-3" href="{{ url_for('editar_perfil') }}">üë§ Mi Ficha</a>
            <a class="nav-link text-white d-inline" href="{{ url_for('logout') }}">Salir</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="btn-group w-100 mb-4">
        <a href="{{ url_for('cargar_registro') }}" class="btn btn-primary">Cargar Datos</a>
        <a href="{{ url_for('ver_registros') }}" class="btn btn-outline-primary">Ver Historial</a>
    </div>

    {% if modo == 'cargar' %}
    <div class="card p-4">
        <h4 class="text-center mb-3">Nuevo Registro</h4>
        {% if success %}<div class="alert alert-success">{{ success }}</div>{% endif %}
        <form action="{{ url_for('cargar_registro') }}" method="POST">
            <div class="row g-3">
                <div class="col-6"><label>Fecha</label><input type="date" name="fecha" class="form-control" required id="f_input"></div>
                <div class="col-6"><label>Hora</label><input type="time" name="hora" class="form-control" required id="h_input"></div>
                <div class="col-12">
                    <select class="form-select form-select-lg" id="tipo_registro" name="tipo_registro" onchange="mostrarCampos()">
                        <option value="drenaje">üíß Drenaje</option>
                        <option value="presion">‚ù§Ô∏è Presi√≥n / Pulso</option>
                        <option value="glucosa">ü©∏ Glucosa</option>
                        <option value="oxigeno">üå¨Ô∏è Saturaci√≥n O‚ÇÇ</option>
                        <option value="temperatura">üå°Ô∏è Temperatura</option>
                    </select>
                </div>
                <div id="campos_drenaje" class="row g-2 mt-1">
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_izq" class="form-control" placeholder="Izq (ml)"></div>
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_der" class="form-control" placeholder="Der (ml)"></div>
                </div>
                <div id="campos_presion" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-4"><input type="number" name="presion_alta" class="form-control" placeholder="Alta"></div>
                    <div class="col-4"><input type="number" name="presion_baja" class="form-control" placeholder="Baja"></div>
                    <div class="col-4"><input type="number" name="pulso" class="form-control" placeholder="Pulso"></div>
                </div>
                <div id="campos_glucosa" class="row g-2 mt-1 seccion-oculta"><div class="col-12"><input type="number" name="glucosa" class="form-control" placeholder="Glucosa mg/dL"></div></div>
                <div id="campos_oxigeno" class="row g-2 mt-1 seccion-oculta"><div class="col-12"><input type="number" name="oxigeno" class="form-control" placeholder="Saturaci√≥n %"></div></div>
                <div id="campos_temperatura" class="row g-2 mt-1 seccion-oculta"><div class="col-12"><input type="number" step="0.1" name="temperatura" class="form-control" placeholder="Temperatura ¬∞C"></div></div>
                <div class="col-12"><textarea name="observaciones" class="form-control" rows="2" placeholder="Observaciones..."></textarea></div>
                <button type="submit" class="btn btn-success w-100 p-3 fw-bold mt-3">GUARDAR</button>
            </div>
        </form>
    </div>
    <script>
        document.getElementById('f_input').valueAsDate = new Date();
        document.getElementById('h_input').value = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
    </script>
    {% endif %}

    {% if modo == 'ver' %}
    <div class="row">
        <div class="col-12 col-md-6"><div class="card p-2"><h6>‚ù§Ô∏è Presi√≥n y Pulso</h6><canvas id="chartPresion"></canvas></div></div>
        <div class="col-12 col-md-6"><div class="card p-2"><h6>üíß Drenaje (ml)</h6><canvas id="chartDrenaje"></canvas></div></div>
        <div class="col-12 col-md-6"><div class="card p-2"><h6>üå¨Ô∏è O‚ÇÇ y üå°Ô∏è Temperatura</h6><canvas id="chartO2Temp"></canvas></div></div>
        <div class="col-12 col-md-6"><div class="card p-2"><h6>ü©∏ Glucosa</h6><canvas id="chartGlucosa"></canvas></div></div>
    </div>

    <script>
        const configGral = { responsive: true, maintainAspectRatio: false };

        // GR√ÅFICO PRESI√ìN
        new Chart(document.getElementById('chartPresion'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Alta', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_alta or 'null'}},{% endif %}{% endfor %}], borderColor: '#dc3545', yAxisID: 'y' },
                    { label: 'Baja', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_baja or 'null'}},{% endif %}{% endfor %}], borderColor: '#0d6efd', yAxisID: 'y' },
                    { label: 'Pulso', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.pulso or 'null'}},{% endif %}{% endfor %}], borderColor: '#fd7e14', yAxisID: 'y1', borderDash: [5,5] }
                ]
            }, options: { ...configGral, scales: { y: { position: 'left' }, y1: { position: 'right', grid: {drawOnChartArea:false} } } }
        });

        // GR√ÅFICO DRENAJE
        new Chart(document.getElementById('chartDrenaje'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Izq', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_izq or 0}},{% endif %}{% endfor %}], borderColor: '#0d6efd' },
                    { label: 'Der', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_der or 0}},{% endif %}{% endfor %}], borderColor: '#6c757d' }
                ]
            }, options: configGral
        });

        // GR√ÅFICO O2 Y TEMP
        new Chart(document.getElementById('chartO2Temp'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo in ['oxigeno', 'temperatura'] %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'O2%', data: [{% for r in registros|reverse %}{% if r.tipo == 'oxigeno' %}{{r.oxigeno or 'null'}},{% elif r.tipo == 'temperatura' %}null{% endif %}{% endfor %}], borderColor: '#198754', yAxisID: 'y' },
                    { label: 'Temp', data: [{% for r in registros|reverse %}{% if r.tipo == 'temperatura' %}{{r.temperatura or 'null'}},{% elif r.tipo == 'oxigeno' %}null{% endif %}{% endfor %}], borderColor: '#6f42c1', yAxisID: 'y1' }
                ]
            }, options: { ...configGral, scales: { y: { position: 'left', suggestedMin: 90 }, y1: { position: 'right', grid: {drawOnChartArea:false}, suggestedMin: 35 } } }
        });

        // GR√ÅFICO GLUCOSA
        new Chart(document.getElementById('chartGlucosa'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'glucosa' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [{ label: 'mg/dL', data: [{% for r in registros|reverse %}{% if r.tipo == 'glucosa' %}{{r.glucosa or 0}},{% endif %}{% endfor %}], borderColor: '#198754' }]
            }, options: configGral
        });
    </script>
    {% endif %}
</div>

<script>
    function mostrarCampos() {
        const t = document.getElementById('tipo_registro').value;
        const ids = ['campos_drenaje', 'campos_presion', 'campos_glucosa', 'campos_oxigeno', 'campos_temperatura'];
        ids.forEach(id => document.getElementById(id).classList.add('seccion-oculta'));
        document.getElementById('campos_' + t).classList.remove('seccion-oculta');
    }
</script>
</body>
</html>