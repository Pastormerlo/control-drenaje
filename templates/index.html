<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salud - Mauro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border:none; }
        .seccion-oculta { display: none; }
        canvas { max-height: 280px; width: 100% !important; }
        .nav-link { font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand">Mauro Salud</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('editar_perfil') }}">üë§ Mi Ficha</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Salir</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="btn-group w-100 mb-4">
        <a href="{{ url_for('cargar_registro') }}" class="btn btn-primary">Cargar Datos</a>
        <a href="{{ url_for('ver_registros') }}" class="btn btn-outline-primary">Historial y PDF</a>
    </div>

    {% if modo == 'perfil' %}
    <div class="card p-4 shadow">
        <h4 class="text-center mb-3">Ficha Individual</h4>
        <form action="{{ url_for('editar_perfil') }}" method="POST">
            <div class="row g-3">
                <div class="col-12"><label>Nombre y Apellido</label><input type="text" name="nombre" class="form-control" value="{{perfil.nombre_apellido or ''}}" required></div>
                <div class="col-4"><label>Edad</label><input type="number" name="edad" class="form-control" value="{{perfil.edad or ''}}"></div>
                <div class="col-4"><label>Sexo</label><select name="sexo" class="form-select"><option value="M" {% if perfil.sexo=='M' %}selected{% endif %}>M</option><option value="F" {% if perfil.sexo=='F' %}selected{% endif %}>F</option></select></div>
                <div class="col-4"><label>Peso (kg)</label><input type="number" step="0.1" name="peso" class="form-control" value="{{perfil.peso or ''}}"></div>
                <div class="col-12"><label>Obra Social</label><input type="text" name="obra_social" class="form-control" value="{{perfil.obra_social or ''}}"></div>
                <div class="col-12"><label>M√©dico de Cabecera</label><input type="text" name="medico" class="form-control" value="{{perfil.nombre_medico or ''}}"></div>
                <button type="submit" class="btn btn-success w-100 mt-3 p-3 fw-bold">GUARDAR FICHA</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if modo == 'cargar' %}
    <div class="card p-4">
        <h4 class="text-center mb-3">Nuevo Registro</h4>
        {% if success %}<div class="alert alert-success">{{ success }}</div>{% endif %}
        <form action="{{ url_for('cargar_registro') }}" method="POST">
            <div class="row g-3">
                <div class="col-6"><label>Fecha</label><input type="date" name="fecha" class="form-control" required id="f_input"></div>
                <div class="col-6"><label>Hora</label><input type="time" name="hora" class="form-control" required id="h_input"></div>
                <div class="col-12">
                    <select class="form-select form-select-lg" id="tipo_registro" name="tipo_registro" onchange="mostrarCampos()">
                        <option value="drenaje">üíß Drenaje</option>
                        <option value="presion">‚ù§Ô∏è Presi√≥n</option>
                        <option value="glucosa">ü©∏ Glucosa</option>
                    </select>
                </div>
                <div id="campos_drenaje" class="row g-2 mt-1">
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_izq" class="form-control" placeholder="Izq (ml)"></div>
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_der" class="form-control" placeholder="Der (ml)"></div>
                </div>
                <div id="campos_presion" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-4"><label class="small">Alta</label><input type="number" name="presion_alta" class="form-control" placeholder="120"></div>
                    <div class="col-4"><label class="small">Baja</label><input type="number" name="presion_baja" class="form-control" placeholder="80"></div>
                    <div class="col-4"><label class="small">Pulso</label><input type="number" name="pulso" class="form-control" placeholder="70"></div>
                </div>
                <div id="campos_glucosa" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-12"><input type="number" name="glucosa" class="form-control" placeholder="Glucosa (mg/dL)"></div>
                </div>
                <div class="col-12"><label>Observaciones</label><textarea name="observaciones" class="form-control" rows="2"></textarea></div>
                <button type="submit" class="btn btn-success w-100 p-3 fw-bold mt-3">GUARDAR REGISTRO</button>
            </div>
        </form>
    </div>
    <script>
        document.getElementById('f_input').valueAsDate = new Date();
        document.getElementById('h_input').value = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
    </script>
    {% endif %}

    {% if modo == 'ver' %}
    <div class="card p-3 text-center border-primary shadow-sm mb-4">
        <h6 class="mb-3 text-primary">üìÑ Reporte PDF (Descarga Directa)</h6>
        <div class="row g-2">
            <div class="col-4"><button onclick="abrirOpciones(7)" class="btn btn-primary w-100 btn-sm">7 d√≠as</button></div>
            <div class="col-4"><button onclick="abrirOpciones(15)" class="btn btn-primary w-100 btn-sm">15 d√≠as</button></div>
            <div class="col-4"><button onclick="abrirOpciones(30)" class="btn btn-primary w-100 btn-sm">30 d√≠as</button></div>
        </div>
    </div>

    <div class="card p-2 mb-3">
        <h6 class="text-center text-muted small">Control de Drenaje (ml)</h6>
        <canvas id="chartDrenaje"></canvas>
    </div>
    
    <div class="card p-2 mb-3">
        <h6 class="text-center text-muted small">Presi√≥n Arterial vs Pulso</h6>
        <canvas id="chartPresion"></canvas>
    </div>

    <div class="card p-2 mb-3">
        <h6 class="text-center text-muted small">Niveles de Glucosa</h6>
        <canvas id="chartGlucosa"></canvas>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-hover bg-white rounded">
            <thead class="table-dark"><tr><th>Fecha</th><th>Dato</th><th></th></tr></thead>
            <tbody>
                {% for r in registros %}
                <tr>
                    <td><small>{{r.fecha}}</small></td>
                    <td>
                        {% if r.tipo == 'drenaje' %}I:{{r.cant_izq or 0}}|D:{{r.cant_der or 0}}
                        {% elif r.tipo == 'presion' %}{{r.presion_alta}}/{{r.presion_baja}} (P:{{r.pulso or '-'}})
                        {% else %}{{r.glucosa}}mg{% endif %}
                    </td>
                    <td><a href="{{ url_for('borrar', id=r.id) }}" class="text-danger" onclick="return confirm('¬øBorrar?')">üóëÔ∏è</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="modalPDF" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Seleccionar Tipo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body p-4">
            <button onclick="generar('todos')" class="btn btn-outline-dark w-100 mb-2 p-3 text-start">üìä Todo el Historial</button>
            <button onclick="generar('drenaje')" class="btn btn-outline-primary w-100 mb-2 p-3 text-start">üíß Solo Drenaje</button>
            <button onclick="generar('presion')" class="btn btn-outline-danger w-100 mb-2 p-3 text-start">‚ù§Ô∏è Solo Presi√≥n</button>
            <button onclick="generar('glucosa')" class="btn btn-outline-success w-100 p-3 text-start">ü©∏ Solo Glucosa</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        let diasSeleccionados = 7;
        const modal = new bootstrap.Modal(document.getElementById('modalPDF'));
        function abrirOpciones(dias) { diasSeleccionados = dias; modal.show(); }
        function generar(tipo) { window.location.href = `/reporte-pdf?dias=${diasSeleccionados}&tipo=${tipo}`; modal.hide(); }

        const optBase = { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
        };

        // DRENAJE
        new Chart(document.getElementById('chartDrenaje'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Izq', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_izq or 0}},{% endif %}{% endfor %}], borderColor: '#0d6efd', tension: 0.3 },
                    { label: 'Der', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_der or 0}},{% endif %}{% endfor %}], borderColor: '#6c757d', tension: 0.3 }
                ]
            }, options: optBase
        });

        // PRESI√ìN CON DOBLE EJE Y PULSO
        new Chart(document.getElementById('chartPresion'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { 
                        label: 'Alta', 
                        data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_alta or 'null'}},{% endif %}{% endfor %}], 
                        borderColor: '#dc3545', backgroundColor: '#dc3545', yAxisID: 'y', tension: 0.2
                    },
                    { 
                        label: 'Baja', 
                        data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_baja or 'null'}},{% endif %}{% endfor %}], 
                        borderColor: '#0d6efd', backgroundColor: '#0d6efd', yAxisID: 'y', tension: 0.2
                    },
                    { 
                        label: 'Pulso (Der)', 
                        data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.pulso or 'null'}},{% endif %}{% endfor %}], 
                        borderColor: '#fd7e14', // Naranja
                        backgroundColor: '#fd7e14',
                        borderDash: [5, 5], 
                        pointRadius: 4,
                        yAxisID: 'y1', 
                        tension: 0.2
                    }
                ]
            }, options: {
                ...optBase,
                scales: {
                    y: { 
                        type: 'linear', position: 'left', 
                        title: { display: true, text: 'mmHg', font: { size: 10 } },
                        suggestedMin: 40 
                    },
                    y1: { 
                        type: 'linear', position: 'right', 
                        title: { display: true, text: 'BPM', font: { size: 10 } },
                        grid: { drawOnChartArea: false },
                        suggestedMin: 40, suggestedMax: 120
                    }
                }
            }
        });

        // GLUCOSA
        new Chart(document.getElementById('chartGlucosa'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'glucosa' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [{ label: 'Glucosa', data: [{% for r in registros|reverse %}{% if r.tipo == 'glucosa' %}{{r.glucosa or 0}},{% endif %}{% endfor %}], borderColor: '#198754', tension: 0.3 }]
            }, options: optBase
        });
    </script>
    {% endif %}
</div>

<script>
    function mostrarCampos() {
        const t = document.getElementById('tipo_registro').value;
        document.getElementById('campos_drenaje').classList.toggle('seccion-oculta', t !== 'drenaje');
        document.getElementById('campos_presion').classList.toggle('seccion-oculta', t !== 'presion');
        document.getElementById('campos_glucosa').classList.toggle('seccion-oculta', t !== 'glucosa');
    }
</script>
</body>
</html>