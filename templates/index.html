<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Salud - Mauro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .seccion-oculta { display: none; }
        .badge-drenaje { background-color: #0d6efd; color: white; padding: 5px 10px; border-radius: 5px; }
        .badge-presion { background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 5px; }
        .badge-glucosa { background-color: #ffc107; color: black; padding: 5px 10px; border-radius: 5px; }
        canvas { max-height: 250px; width: 100% !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-4 shadow-sm">
    <div class="container d-flex justify-content-between">
        <span class="navbar-brand mb-0 h1">üè• Control M√©dico</span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Salir</a>
    </div>
</nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center mb-4">
            <div class="btn-group w-100 shadow-sm">
                <a href="{{ url_for('cargar_registro') }}" class="btn {% if modo == 'cargar' %}btn-primary{% else %}btn-outline-primary{% endif %}">Cargar</a>
                <a href="{{ url_for('ver_registros') }}" class="btn {% if modo == 'ver' %}btn-primary{% else %}btn-outline-primary{% endif %}">Historial</a>
            </div>
        </div>

        {% if modo == 'cargar' %}
        <div class="col-md-8">
            <div class="card p-4">
                <h3 class="text-center mb-4">Nuevo Registro</h3>
                {% if success %}<div class="alert alert-success text-center">{{ success }}</div>{% endif %}
                <form action="{{ url_for('cargar_registro') }}" method="POST">
                    <div class="row g-3">
                        <div class="col-6"><label class="form-label">Fecha</label><input type="date" name="fecha" id="f_act" class="form-control" required></div>
                        <div class="col-6"><label class="form-label">Hora</label><input type="time" name="hora" id="h_act" class="form-control" required></div>
                        <div class="col-12 mt-3">
                            <select class="form-select form-select-lg" id="tipo_registro" name="tipo_registro" onchange="mostrarCampos()">
                                <option value="drenaje">üíß Drenaje</option>
                                <option value="presion">‚ù§Ô∏è Presi√≥n / Pulso</option>
                                <option value="glucosa">ü©∏ Glucosa</option>
                            </select>
                        </div>
                        <div id="campos_drenaje" class="row g-3 mt-1">
                            <div class="col-6"><label>Izq (ml)</label><input type="number" step="0.1" name="cantidad_izq" class="form-control"></div>
                            <div class="col-6"><label>Der (ml)</label><input type="number" step="0.1" name="cantidad_der" class="form-control"></div>
                        </div>
                        <div id="campos_presion" class="row g-3 mt-1 seccion-oculta">
                            <div class="col-4"><label>Alta</label><input type="number" name="presion_alta" class="form-control"></div>
                            <div class="col-4"><label>Baja</label><input type="number" name="presion_baja" class="form-control"></div>
                            <div class="col-4"><label>Pulso</label><input type="number" name="pulso" class="form-control"></div>
                        </div>
                        <div id="campos_glucosa" class="row g-3 mt-1 seccion-oculta">
                            <div class="col-12"><label>Nivel (mg/dL)</label><input type="number" name="glucosa" class="form-control"></div>
                        </div>
                        <div class="col-12 mt-3"><label>Notas</label><textarea name="observaciones" class="form-control"></textarea></div>
                        <button type="submit" class="btn btn-success w-100 mt-4 py-3 fw-bold">üíæ GUARDAR</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        {% if modo == 'ver' %}
        <div class="col-md-10 text-center">
            <button onclick="generarPDF()" class="btn btn-danger mb-4 w-100 py-2 fw-bold shadow-sm">üìÑ DESCARGAR REPORTE PDF</button>

            <div class="card p-3"><h6>Drenaje: <span style="color:#0d6efd">Izq</span> / <span style="color:#dc3545">Der</span></h6><canvas id="chartDrenaje"></canvas></div>
            <div class="card p-3"><h6>Presi√≥n (<span style="color:#dc3545">A</span>/<span style="color:#0d6efd">B</span>) y <span style="color:#198754">Pulso</span></h6><canvas id="chartPresion"></canvas></div>
            <div class="card p-3"><h6>Glucosa (mg/dL)</h6><canvas id="chartGlucosa"></canvas></div>

            <div class="card p-3">
                <div class="table-responsive">
                    <table id="tablaHistorial" class="table align-middle text-start small">
                        <thead><tr><th>Fecha</th><th>Tipo</th><th>Medici√≥n</th><th></th></tr></thead>
                        <tbody>
                            {% for r in registros %}
                            <tr>
                                <td>{{ r.fecha }}<br><small class="text-muted">{{ r.hora }}</small></td>
                                <td>{{ r.tipo|capitalize }}</td>
                                <td>
                                    {% if r.tipo == 'drenaje' %}I:{{r.cant_izq or 0}}/D:{{r.cant_der or 0}}ml
                                    {% elif r.tipo == 'presion' %}{{r.presion_alta}}/{{r.presion_baja}} (P:{{r.pulso or '-'}})
                                    {% elif r.tipo == 'glucosa' %}{{r.glucosa}} mg/dL
                                    {% endif %}
                                </td>
                                <td><a href="{{ url_for('borrar', id=r.id) }}" class="text-danger" onclick="return confirm('¬øBorrar?')">üóëÔ∏è</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

        <script>
            const rawData = [ {% for r in registros|reverse %} { fecha: "{{r.fecha}}", hora: "{{r.hora}}", tipo: "{{r.tipo}}", izq: {{ r.cant_izq or 0 }}, der: {{ r.cant_der or 0 }}, alta: {{r.presion_alta or 0}}, baja: {{r.presion_baja or 0}}, pulso: {{r.pulso or 0}}, glu: {{r.glucosa or 0}}, obs: "{{r.observaciones or ''}}" }, {% endfor %} ];
            
            // GRAFICOS (Igual que antes pero con doble eje en presi√≥n)
            const dData = rawData.filter(d => d.tipo === 'drenaje');
            new Chart(document.getElementById('chartDrenaje'), { type: 'line', data: { labels: dData.map(d => d.fecha), datasets: [{ label: 'Izq', data: dData.map(d => d.izq), borderColor: '#0d6efd' }, { label: 'Der', data: dData.map(d => d.der), borderColor: '#dc3545' }] } });

            const pData = rawData.filter(d => d.tipo === 'presion');
            new Chart(document.getElementById('chartPresion'), { 
                type: 'line', 
                data: { 
                    labels: pData.map(d => d.fecha), 
                    datasets: [
                        { label: 'Alta', data: pData.map(d => d.alta), borderColor: '#dc3545', yAxisID: 'yP' },
                        { label: 'Baja', data: pData.map(d => d.baja), borderColor: '#0d6efd', yAxisID: 'yP' },
                        { label: 'Pulso', data: pData.map(d => d.pulso), borderColor: '#198754', borderDash: [5,5], yAxisID: 'yL' }
                    ] 
                },
                options: { scales: { yP: { type: 'linear', position: 'left' }, yL: { type: 'linear', position: 'right', grid: {drawOnChartArea: false} } } }
            });

            new Chart(document.getElementById('chartGlucosa'), { type: 'line', data: { labels: rawData.filter(d => d.tipo === 'glucosa').map(d => d.fecha), datasets: [{ label: 'mg/dL', data: rawData.filter(d => d.tipo === 'glucosa').map(d => d.glu), borderColor: '#ffc107' }] } });

            // FUNCI√ìN PARA GENERAR PDF
            async function generarPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text("Reporte de Control M√©dico", 14, 20);
                doc.setFontSize(12);
                doc.text("Paciente: Madre de Mauro - Generado el: " + new Date().toLocaleDateString(), 14, 30);

                const tableBody = rawData.reverse().map(r => {
                    let med = "";
                    if(r.tipo === 'drenaje') med = `Izq: ${r.izq}ml / Der: ${r.der}ml`;
                    else if(r.tipo === 'presion') med = `${r.alta}/${r.baja} (P: ${r.pulso})`;
                    else med = `${r.glu} mg/dL`;
                    return [r.fecha, r.hora, r.tipo.toUpperCase(), med, r.obs];
                });

                doc.autoTable({
                    startY: 40,
                    head: [['Fecha', 'Hora', 'Tipo', 'Medici√≥n', 'Observaciones']],
                    body: tableBody,
                    theme: 'grid'
                });

                doc.save(`Reporte_Salud_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        </script>
        {% endif %}
    </div>
</div>

<script>
function mostrarCampos() {
    const t = document.getElementById('tipo_registro').value;
    document.getElementById('campos_drenaje').classList.toggle('seccion-oculta', t !== 'drenaje');
    document.getElementById('campos_presion').classList.toggle('seccion-oculta', t !== 'presion');
    document.getElementById('campos_glucosa').classList.toggle('seccion-oculta', t !== 'glucosa');
}
window.onload = function() {
    const n = new Date();
    if(document.getElementById('f_act')) document.getElementById('f_act').value = n.toISOString().split('T')[0];
    if(document.getElementById('h_act')) document.getElementById('h_act').value = n.getHours().toString().padStart(2,'0')+':'+n.getMinutes().toString().padStart(2,'0');
};
</script>
</body>
</html>