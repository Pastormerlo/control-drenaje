<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salud - Mauro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border:none; }
        .seccion-oculta { display: none; }
        canvas { max-height: 250px; width: 100% !important; }
        .nav-link { font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand">Mauro Salud</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('editar_perfil') }}">üë§ Mi Ficha</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Salir</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="btn-group w-100 mb-4">
        <a href="{{ url_for('cargar_registro') }}" class="btn btn-primary">Cargar Datos</a>
        <a href="{{ url_for('ver_registros') }}" class="btn btn-outline-primary">Historial y PDF</a>
    </div>

    {% if modo == 'perfil' %}
    <div class="card p-4 shadow">
        <h4 class="text-center mb-3">Ficha Individual</h4>
        <form action="{{ url_for('editar_perfil') }}" method="POST">
            <div class="row g-3">
                <div class="col-12"><label>Nombre y Apellido</label><input type="text" name="nombre" class="form-control" value="{{perfil.nombre_apellido or ''}}" required></div>
                <div class="col-4"><label>Edad</label><input type="number" name="edad" class="form-control" value="{{perfil.edad or ''}}"></div>
                <div class="col-4"><label>Sexo</label><select name="sexo" class="form-select"><option value="M" {% if perfil.sexo=='M' %}selected{% endif %}>M</option><option value="F" {% if perfil.sexo=='F' %}selected{% endif %}>F</option></select></div>
                <div class="col-4"><label>Peso (kg)</label><input type="number" step="0.1" name="peso" class="form-control" value="{{perfil.peso or ''}}"></div>
                <div class="col-12"><label>Obra Social</label><input type="text" name="obra_social" class="form-control" value="{{perfil.obra_social or ''}}"></div>
                <div class="col-12"><label>M√©dico de Cabecera</label><input type="text" name="medico" class="form-control" value="{{perfil.nombre_medico or ''}}"></div>
                <button type="submit" class="btn btn-success w-100 mt-3 p-3 fw-bold">GUARDAR FICHA</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if modo == 'cargar' %}
    <div class="card p-4">
        <h4 class="text-center mb-3">Nuevo Registro</h4>
        {% if success %}<div class="alert alert-success">{{ success }}</div>{% endif %}
        <form action="{{ url_for('cargar_registro') }}" method="POST">
            <div class="row g-3">
                <div class="col-6"><label>Fecha</label><input type="date" name="fecha" class="form-control" required id="f_input"></div>
                <div class="col-6"><label>Hora</label><input type="time" name="hora" class="form-control" required id="h_input"></div>
                <div class="col-12">
                    <select class="form-select form-select-lg" id="tipo_registro" name="tipo_registro" onchange="mostrarCampos()">
                        <option value="drenaje">üíß Drenaje</option>
                        <option value="presion">‚ù§Ô∏è Presi√≥n / Pulso</option>
                        <option value="glucosa">ü©∏ Glucosa</option>
                        <option value="oxigeno">üå¨Ô∏è Saturaci√≥n O‚ÇÇ</option>
                        <option value="temperatura">üå°Ô∏è Temperatura</option>
                    </select>
                </div>
                <div id="campos_drenaje" class="row g-2 mt-1">
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_izq" class="form-control" placeholder="Izq (ml)"></div>
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_der" class="form-control" placeholder="Der (ml)"></div>
                </div>
                <div id="campos_presion" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-4"><input type="number" name="presion_alta" class="form-control" placeholder="Alta"></div>
                    <div class="col-4"><input type="number" name="presion_baja" class="form-control" placeholder="Baja"></div>
                    <div class="col-4"><input type="number" name="pulso" class="form-control" placeholder="Pulso"></div>
                </div>
                <div id="campos_glucosa" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-12"><input type="number" name="glucosa" class="form-control" placeholder="mg/dL"></div>
                </div>
                <div id="campos_oxigeno" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-12"><input type="number" name="oxigeno" class="form-control" placeholder="Saturaci√≥n %"></div>
                </div>
                <div id="campos_temperatura" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-12"><input type="number" step="0.1" name="temperatura" class="form-control" placeholder="Temperatura ¬∞C"></div>
                </div>
                <div class="col-12"><label>Observaciones</label><textarea name="observaciones" class="form-control" rows="2"></textarea></div>
                <button type="submit" class="btn btn-success w-100 p-3 fw-bold mt-3">GUARDAR</button>
            </div>
        </form>
    </div>
    <script>
        document.getElementById('f_input').valueAsDate = new Date();
        document.getElementById('h_input').value = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
        function mostrarCampos() {
            const t = document.getElementById('tipo_registro').value;
            document.getElementById('campos_drenaje').classList.toggle('seccion-oculta', t !== 'drenaje');
            document.getElementById('campos_presion').classList.toggle('seccion-oculta', t !== 'presion');
            document.getElementById('campos_glucosa').classList.toggle('seccion-oculta', t !== 'glucosa');
            document.getElementById('campos_oxigeno').classList.toggle('seccion-oculta', t !== 'oxigeno');
            document.getElementById('campos_temperatura').classList.toggle('seccion-oculta', t !== 'temperatura');
        }
    </script>
    {% endif %}

    {% if modo == 'ver' %}
    <div class="card p-2 mb-3"><h6 class="text-center small">Drenaje</h6><canvas id="chartDrenaje"></canvas></div>
    <div class="card p-2 mb-3"><h6 class="text-center small">Presi√≥n y Pulso</h6><canvas id="chartPresion"></canvas></div>
    <div class="card p-2 mb-3"><h6 class="text-center small">Oxigeno y Temperatura</h6><canvas id="chartOxigeno"></canvas></div>
    
    <div class="table-responsive">
        <table class="table table-sm table-hover bg-white rounded">
            <thead class="table-dark"><tr><th>Fecha</th><th>Tipo</th><th>Dato</th><th></th></tr></thead>
            <tbody>
                {% for r in registros %}
                <tr>
                    <td><small>{{r.fecha}}</small></td>
                    <td><small>{{r.tipo}}</small></td>
                    <td>
                        {% if r.tipo == 'drenaje' %}{{r.cant_izq or 0}}|{{r.cant_der or 0}}
                        {% elif r.tipo == 'presion' %}{{r.presion_alta}}/{{r.presion_baja}}
                        {% elif r.tipo == 'oxigeno' %}{{r.oxigeno}}%
                        {% elif r.tipo == 'temperatura' %}{{r.temperatura}}¬∞
                        {% else %}{{r.glucosa}}mg{% endif %}
                    </td>
                    <td><a href="{{ url_for('borrar', id=r.id) }}" class="text-danger">üóëÔ∏è</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const opt = { responsive: true, maintainAspectRatio: false };
        
        // Gr√°fico Presi√≥n/Pulso (Doble Eje)
        new Chart(document.getElementById('chartPresion'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Alta', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_alta or 'null'}},{% endif %}{% endfor %}], borderColor: '#dc3545', yAxisID: 'y' },
                    { label: 'Baja', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_baja or 'null'}},{% endif %}{% endfor %}], borderColor: '#0d6efd', yAxisID: 'y' },
                    { label: 'Pulso', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.pulso or 'null'}},{% endif %}{% endfor %}], borderColor: '#fd7e14', borderDash: [5,5], yAxisID: 'y1' }
                ]
            },
            options: { ...opt, scales: { y: {position: 'left'}, y1: {position: 'right', grid: {drawOnChartArea: false}, suggestedMin: 40} } }
        });

        // Gr√°fico Oxigeno y Temperatura (Doble Eje)
        new Chart(document.getElementById('chartOxigeno'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo in ['oxigeno', 'temperatura'] %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'O2 %', data: [{% for r in registros|reverse %}{% if r.tipo == 'oxigeno' %}{{r.oxigeno}},{% elif r.tipo == 'temperatura' %}null{% endif %}{% endfor %}], borderColor: '#198754', yAxisID: 'y' },
                    { label: 'Temp ¬∞C', data: [{% for r in registros|reverse %}{% if r.tipo == 'temperatura' %}{{r.temperatura}},{% elif r.tipo == 'oxigeno' %}null{% endif %}{% endfor %}], borderColor: '#6f42c1', yAxisID: 'y1' }
                ]
            },
            options: { ...opt, scales: { y: {position: 'left', suggestedMin: 90}, y1: {position: 'right', grid: {drawOnChartArea: false}, suggestedMin: 35} } }
        });
        
        // Gr√°fico Drenaje (se mantiene igual)
        new Chart(document.getElementById('chartDrenaje'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'I', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_izq or 0}},{% endif %}{% endfor %}], borderColor: '#0d6efd' },
                    { label: 'D', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_der or 0}},{% endif %}{% endfor %}], borderColor: '#6c757d' }
                ]
            }, options: opt
        });
    </script>
    {% endif %}
</div>
</body>
</html>