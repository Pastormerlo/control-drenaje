<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salud - Mauro</title>
    <link rel="manifest" href="/static/manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border:none; }
        .seccion-oculta { display: none; }
        .btn-reporte { font-weight: bold; border-radius: 10px; padding: 12px; }
        canvas { max-height: 230px; width: 100% !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">Mauro Salud</span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Salir</a>
    </div>
</nav>

<div class="container">
    <div class="btn-group w-100 mb-4">
        <a href="{{ url_for('cargar_registro') }}" class="btn btn-primary">Cargar Datos</a>
        <a href="{{ url_for('ver_registros') }}" class="btn btn-outline-primary">Historial y Gr√°ficos</a>
    </div>

    {% if modo == 'cargar' %}
    <div class="card p-4 shadow">
        <h4 class="text-center mb-3">Nuevo Registro</h4>
        {% if success %}<div class="alert alert-success">{{ success }}</div>{% endif %}
        <form action="{{ url_for('cargar_registro') }}" method="POST">
            <div class="row g-3">
                <div class="col-6"><label>Fecha</label><input type="date" name="fecha" class="form-control" required id="f_input"></div>
                <div class="col-6"><label>Hora</label><input type="time" name="hora" class="form-control" required id="h_input"></div>
                
                <div class="col-12">
                    <label>¬øQu√© vas a medir?</label>
                    <select class="form-select form-select-lg" id="tipo_registro" name="tipo_registro" onchange="mostrarCampos()">
                        <option value="drenaje">üíß Drenaje</option>
                        <option value="presion">‚ù§Ô∏è Presi√≥n Arterial</option>
                        <option value="glucosa">ü©∏ Glucosa</option>
                    </select>
                </div>

                <div id="campos_drenaje" class="row g-2 mt-1">
                    <div class="col-6"><label>Izq (ml)</label><input type="number" step="0.1" name="cantidad_izq" class="form-control"></div>
                    <div class="col-6"><label>Der (ml)</label><input type="number" step="0.1" name="cantidad_der" class="form-control"></div>
                </div>

                <div id="campos_presion" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-4"><label>Alta</label><input type="number" name="presion_alta" class="form-control"></div>
                    <div class="col-4"><label>Baja</label><input type="number" name="presion_baja" class="form-control"></div>
                    <div class="col-4"><label>Pulso</label><input type="number" name="pulso" class="form-control"></div>
                </div>

                <div id="campos_glucosa" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-12"><label>Glucosa (mg/dL)</label><input type="number" name="glucosa" class="form-control"></div>
                </div>

                <div class="col-12"><label>Observaciones</label><textarea name="observaciones" class="form-control" rows="2"></textarea></div>
                <button type="submit" class="btn btn-success w-100 p-3 fw-bold mt-3">GUARDAR REGISTRO</button>
            </div>
        </form>
    </div>
    <script>
        document.getElementById('f_input').valueAsDate = new Date();
        document.getElementById('h_input').value = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
    </script>
    {% endif %}

    {% if modo == 'ver' %}
    <div class="card p-3 text-center border-primary shadow-sm mb-4">
        <h6 class="mb-3 text-primary">üìÑ Descargar Reporte PDF</h6>
        <div class="row g-2">
            <div class="col-4"><button onclick="abrirOpciones(7)" class="btn btn-primary w-100 btn-reporte btn-sm">7 d√≠as</button></div>
            <div class="col-4"><button onclick="abrirOpciones(15)" class="btn btn-primary w-100 btn-reporte btn-sm">15 d√≠as</button></div>
            <div class="col-4"><button onclick="abrirOpciones(30)" class="btn btn-primary w-100 btn-reporte btn-sm">30 d√≠as</button></div>
        </div>
    </div>

    <div class="card p-2 mb-3"><h6 class="text-center text-primary small">Drenaje (ml)</h6><canvas id="chartDrenaje"></canvas></div>
    <div class="card p-2 mb-3"><h6 class="text-center text-danger small">Presi√≥n Arterial</h6><canvas id="chartPresion"></canvas></div>
    <div class="card p-2 mb-3"><h6 class="text-center text-success small">Glucosa (mg/dL)</h6><canvas id="chartGlucosa"></canvas></div>

    <div class="table-responsive mt-4">
        <table class="table table-sm table-hover bg-white rounded shadow-sm">
            <thead class="table-dark"><tr><th>Fecha</th><th>Dato</th><th></th></tr></thead>
            <tbody>
                {% for r in registros %}
                <tr>
                    <td><small>{{r.fecha}}</small></td>
                    <td>
                        {% if r.tipo == 'drenaje' %}I:{{r.cant_izq or 0}}|D:{{r.cant_der or 0}}
                        {% elif r.tipo == 'presion' %}{{r.presion_alta}}/{{r.presion_baja}}
                        {% else %}{{r.glucosa}}mg{% endif %}
                    </td>
                    <td><a href="{{ url_for('borrar', id=r.id) }}" class="text-danger" onclick="return confirm('¬øBorrar?')">üóëÔ∏è</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="modalPDF" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Reporte <span id="dias_span"></span> d√≠as</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-4">
            <button onclick="generar('todos')" class="btn btn-outline-dark w-100 mb-2 p-3 text-start">üìä Todo</button>
            <button onclick="generar('drenaje')" class="btn btn-outline-primary w-100 mb-2 p-3 text-start">üíß Solo Drenaje</button>
            <button onclick="generar('presion')" class="btn btn-outline-danger w-100 mb-2 p-3 text-start">‚ù§Ô∏è Solo Presi√≥n</button>
            <button onclick="generar('glucosa')" class="btn btn-outline-success w-100 p-3 text-start">ü©∏ Solo Glucosa</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        let diasSeleccionados = 7;
        const modal = new bootstrap.Modal(document.getElementById('modalPDF'));
        function abrirOpciones(dias) {
            diasSeleccionados = dias;
            document.getElementById('dias_span').innerText = dias;
            modal.show();
        }
        function generar(tipo) {
            window.location.href = `/reporte-pdf?dias=${diasSeleccionados}&tipo=${tipo}`;
            modal.hide();
        }

        // L√≥gica de Gr√°ficos corregida
        new Chart(document.getElementById('chartDrenaje'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Izq', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_izq or 0}},{% endif %}{% endfor %}], borderColor: '#0d6efd', tension: 0.3 },
                    { label: 'Der', data: [{% for r in registros|reverse %}{% if r.tipo == 'drenaje' %}{{r.cant_der or 0}},{% endif %}{% endfor %}], borderColor: '#6c757d', tension: 0.3 }
                ]
            }
        });

        new Chart(document.getElementById('chartPresion'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Alta', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_alta or 0}},{% endif %}{% endfor %}], borderColor: '#dc3545' },
                    { label: 'Baja', data: [{% for r in registros|reverse %}{% if r.tipo == 'presion' %}{{r.presion_baja or 0}},{% endif %}{% endfor %}], borderColor: '#0d6efd' }
                ]
            }
        });

        new Chart(document.getElementById('chartGlucosa'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.tipo == 'glucosa' %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [{
                    label: 'mg/dL',
                    data: [{% for r in registros|reverse %}{% if r.tipo == 'glucosa' %}{{r.glucosa or 0}},{% endif %}{% endfor %}],
                    borderColor: '#198754', fill: true, backgroundColor: 'rgba(25,135,84,0.1)'
                }]
            }
        });
    </script>
    {% endif %}
</div>

<script>
    function mostrarCampos() {
        const t = document.getElementById('tipo_registro').value;
        document.getElementById('campos_drenaje').classList.toggle('seccion-oculta', t !== 'drenaje');
        document.getElementById('campos_presion').classList.toggle('seccion-oculta', t !== 'presion');
        document.getElementById('campos_glucosa').classList.toggle('seccion-oculta', t !== 'glucosa');
    }
</script>
</body>
</html>