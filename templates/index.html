<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mauro Salud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, sans-serif; }
        .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-val { font-size: 1.6rem; font-weight: bold; line-height: 1.2; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; color: #6c757d; font-weight: 700; letter-spacing: 0.5px; }
        .badge-alert { background-color: #ffe5e5; color: #d90429; font-weight: bold; font-size: 0.65rem; }
        .seccion-oculta { display: none; }
        .nav-link-custom { color: white; text-decoration: none; font-size: 0.9rem; font-weight: 500; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-4 shadow-sm">
    <div class="container">
        <span class="navbar-brand fw-bold">Mauro Salud</span>
        <div>
            <a href="{{ url_for('editar_perfil') }}" class="nav-link-custom me-3">üë§ Mi Ficha</a>
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-light fw-bold">Salir</a>
        </div>
    </div>
</nav>

<div class="container pb-5">
    <div class="btn-group w-100 mb-4 shadow-sm bg-white rounded">
        <a href="{{ url_for('cargar_registro') }}" class="btn btn-white py-2 {% if modo=='cargar' %}active btn-primary text-white{% endif %}">‚ûï Cargar</a>
        <a href="{{ url_for('ver_registros') }}" class="btn btn-white py-2 {% if modo=='ver' %}active btn-primary text-white{% endif %}">üìä Indicadores</a>
    </div>

    {% if modo == 'perfil' %}
    <div class="card p-4">
        <h5 class="mb-4 fw-bold text-primary">Mi Ficha Individual</h5>
        {% with msgs = get_flashed_messages() %}{% if msgs %}<div class="alert alert-success">{{msgs[0]}}</div>{% endif %}{% endwith %}
        <form action="{{ url_for('editar_perfil') }}" method="POST">
            <div class="row g-3">
                <div class="col-12"><label class="small fw-bold">Nombre y Apellido</label><input type="text" name="nombre" class="form-control" value="{{perfil.nombre_apellido or ''}}" required></div>
                <div class="col-6"><label class="small fw-bold">Edad</label><input type="number" name="edad" class="form-control" value="{{perfil.edad or ''}}"></div>
                <div class="col-6"><label class="small fw-bold">Sexo</label><select name="sexo" class="form-select"><option value="M" {% if perfil.sexo=='M' %}selected{% endif %}>M</option><option value="F" {% if perfil.sexo=='F' %}selected{% endif %}>F</option></select></div>
                <div class="col-12"><label class="small fw-bold">Obra Social</label><input type="text" name="obra_social" class="form-control" value="{{perfil.obra_social or ''}}"></div>
                <div class="col-12"><label class="small fw-bold">M√©dico</label><input type="text" name="medico" class="form-control" value="{{perfil.nombre_medico or ''}}"></div>
                <button type="submit" class="btn btn-success w-100 p-3 fw-bold mt-2">GUARDAR CAMBIOS</button>
            </div>
        </form>
    </div>
    {% endif %}

    {% if modo == 'cargar' %}
    <div class="card p-4">
        <h5 class="mb-4 fw-bold text-primary">Nuevo Registro</h5>
        {% if success %}<div class="alert alert-success small">{{ success }}</div>{% endif %}
        <form action="{{ url_for('cargar_registro') }}" method="POST">
            <div class="row g-3">
                <div class="col-6"><label class="small fw-bold">Fecha</label><input type="date" name="fecha" class="form-control" id="f_input" required></div>
                <div class="col-6"><label class="small fw-bold">Hora</label><input type="time" name="hora" class="form-control" id="h_input" required></div>
                <div class="col-12">
                    <select class="form-select form-select-lg fw-bold" id="tipo_registro" name="tipo_registro" onchange="mostrarCampos()">
                        <option value="presion">‚ù§Ô∏è Presi√≥n y Pulso</option>
                        <option value="glucosa">ü©∏ Glucosa</option>
                        <option value="drenaje">üíß Drenaje</option>
                        <option value="oxigeno">üå¨Ô∏è Saturaci√≥n O‚ÇÇ</option>
                        <option value="temperatura">üå°Ô∏è Temperatura</option>
                    </select>
                </div>
                <div id="campos_presion" class="row g-2 mt-1">
                    <div class="col-4"><input type="number" name="presion_alta" class="form-control" placeholder="Alta"></div>
                    <div class="col-4"><input type="number" name="presion_baja" class="form-control" placeholder="Baja"></div>
                    <div class="col-4"><input type="number" name="pulso" class="form-control" placeholder="Pulso"></div>
                </div>
                <div id="campos_glucosa" class="row g-2 mt-1 seccion-oculta"><div class="col-12"><input type="number" name="glucosa" class="form-control" placeholder="mg/dL"></div></div>
                <div id="campos_oxigeno" class="row g-2 mt-1 seccion-oculta"><div class="col-12"><input type="number" name="oxigeno" class="form-control" placeholder="Sat %"></div></div>
                <div id="campos_temperatura" class="row g-2 mt-1 seccion-oculta"><div class="col-12"><input type="number" step="0.1" name="temperatura" class="form-control" placeholder="¬∞C"></div></div>
                <div id="campos_drenaje" class="row g-2 mt-1 seccion-oculta">
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_izq" class="form-control" placeholder="Izq (ml)"></div>
                    <div class="col-6"><input type="number" step="0.1" name="cantidad_der" class="form-control" placeholder="Der (ml)"></div>
                </div>
                <div class="col-12"><textarea name="observaciones" class="form-control" rows="2" placeholder="Notas..."></textarea></div>
                <button type="submit" class="btn btn-primary w-100 p-3 fw-bold mt-3">GUARDAR</button>
            </div>
        </form>
    </div>
    <script>
        document.getElementById('f_input').valueAsDate = new Date();
        document.getElementById('h_input').value = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
        function mostrarCampos() {
            const t = document.getElementById('tipo_registro').value;
            ['presion','glucosa','drenaje','oxigeno','temperatura'].forEach(id => document.getElementById('campos_'+id).classList.add('seccion-oculta'));
            document.getElementById('campos_'+t).classList.remove('seccion-oculta');
        }
    </script>
    {% endif %}

    {% if modo == 'ver' %}
    <h6 class="stat-label mb-3 text-center">Resumen M√©dico (√öltimos 30 d√≠as)</h6>
    <div class="row g-3 mb-4">
        <div class="col-6">
            <div class="card p-3 border-start border-danger border-4 h-100">
                <div class="stat-label">‚ù§Ô∏è Presi√≥n Prom.</div>
                <div class="stat-val text-danger">{{stats.presion.prom_a}}/{{stats.presion.prom_b}}</div>
                <div class="mt-1 small text-muted" style="font-size: 0.6rem;">
                    M√ÅX: <strong>{{stats.presion.max_a}}</strong> | M√çN: <strong>{{stats.presion.min_a}}</strong>
                </div>
                {% if stats.presion.alertas > 0 %}<span class="badge badge-alert mt-2">{{stats.presion.alertas}} altas</span>{% endif %}
            </div>
        </div>
        <div class="col-6">
            <div class="card p-3 border-start border-success border-4 h-100">
                <div class="stat-label">ü©∏ Glucosa Prom.</div>
                <div class="stat-val text-success">{{stats.glucosa.prom}}</div>
                <div class="mt-1 small text-muted" style="font-size: 0.6rem;">
                    M√ÅX: <strong>{{stats.glucosa.max}}</strong> | M√çN: <strong>{{stats.glucosa.min}}</strong>
                </div>
                {% if stats.glucosa.alertas > 0 %}<span class="badge badge-alert mt-2">{{stats.glucosa.alertas}} alertas</span>{% endif %}
            </div>
        </div>
        <div class="col-6">
            <div class="card p-3 border-start border-info border-4 h-100">
                <div class="stat-label">üå¨Ô∏è Ox√≠geno Prom.</div>
                <div class="stat-val text-info">{{stats.oxigeno.prom}}%</div>
                <div class="mt-1 small text-muted" style="font-size: 0.6rem;">
                    M√ÅX: <strong>{{stats.oxigeno.max}}%</strong> | M√çN: <strong>{{stats.oxigeno.min}}%</strong>
                </div>
                {% if stats.oxigeno.alertas > 0 %}<span class="badge badge-alert mt-2">{{stats.oxigeno.alertas}} bajas</span>{% endif %}
            </div>
        </div>
        <div class="col-6">
            <div class="card p-3 border-start border-warning border-4 h-100">
                <div class="stat-label">üå°Ô∏è Temp Prom.</div>
                <div class="stat-val text-warning">{{stats.temp.prom}}¬∞</div>
                <div class="mt-1 small text-muted" style="font-size: 0.6rem;">
                    M√ÅX: <strong>{{stats.temp.max}}¬∞</strong> | M√çN: <strong>{{stats.temp.min}}¬∞</strong>
                </div>
                {% if stats.temp.alertas > 0 %}<span class="badge badge-alert mt-2">{{stats.temp.alertas}} picos</span>{% endif %}
            </div>
        </div>
    </div>

    <h6 class="stat-label mb-2">Historial Reciente</h6>
    <div class="card overflow-hidden shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light" style="font-size: 0.65rem;">
                    <tr><th class="ps-3">FECHA/HORA</th><th>TIPO</th><th>VALOR</th><th></th></tr>
                </thead>
                <tbody style="font-size: 0.8rem;">
                    {% for r in registros %}
                    <tr>
                        <td class="ps-3"><div>{{r.fecha}}</div><div class="text-muted small">{{r.hora}}</div></td>
                        <td class="fw-bold text-uppercase">{{r.tipo}}</td>
                        <td>
                            {% if r.tipo == 'presion' %}<span class="text-danger fw-bold">{{r.presion_alta}}/{{r.presion_baja}}</span>
                            {% elif r.tipo == 'glucosa' %}<span class="text-success fw-bold">{{r.glucosa}}</span>
                            {% elif r.tipo == 'oxigeno' %}<span class="text-info fw-bold">{{r.oxigeno}}%</span>
                            {% elif r.tipo == 'temperatura' %}<span class="text-warning fw-bold">{{r.temperatura}}¬∞</span>
                            {% elif r.tipo == 'drenaje' %}I:{{r.cant_izq or 0}}|D:{{r.cant_der or 0}}{% endif %}
                        </td>
                        <td class="text-end pe-3"><a href="{{ url_for('borrar', id=r.id) }}" class="text-danger">üóëÔ∏è</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
</body>
</html>