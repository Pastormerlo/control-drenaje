<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Drenaje</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-3">
    <h3 class="text-center mb-3">ü©∫ Control de Drenaje</h3>

    <form method="POST" class="card p-3 mb-4 shadow-sm">
        <div class="row g-2">
            <div class="col-6">
                <label class="form-label">Fecha</label>
                <input type="date" name="fecha" id="f_auto" class="form-control" required>
            </div>
            <div class="col-6">
                <label class="form-label">Hora</label>
                <input type="time" name="hora" id="h_auto" class="form-control" required>
            </div>
        </div>

        <label class="form-label mt-2">üíß Drenaje izquierdo (ml)</label>
        <input type="number" name="cantidad_izq" step="0.01" class="form-control" placeholder="Ej: 0.75" required>

        <label class="form-label mt-2">üíß Drenaje derecho (ml)</label>
        <input type="number" name="cantidad_der" step="0.01" class="form-control" placeholder="Ej: 1.25" required>

        <label class="form-label mt-2">Observaciones</label>
        <textarea name="observaciones" class="form-control" rows="2" placeholder="Opcional..."></textarea>

        <button class="btn btn-primary mt-3 w-100 fw-bold">Guardar registro</button>
    </form>

    <div class="card mt-4 mb-4 shadow-sm p-3">
        <h5 class="text-center">üìà Evoluci√≥n de Drenajes</h5>
        <canvas id="graficoDrenaje"></canvas>
    </div>

    <h5>üìã Historial</h5>
    <div class="list-group shadow-sm mb-4">
        {% for r in registros %}
        <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">üìÖ {{ r.fecha }} ‚Äî ‚è∞ {{ r.hora }}</h6>
            </div>
            <p class="mb-1">
                <span class="text-primary">üíß Izq: <strong>{{ r.cant_izq }} ml</strong></span> | 
                <span class="text-danger">üíß Der: <strong>{{ r.cant_der }} ml</strong></span>
            </p>
            {% if r.observaciones %}
            <small class="text-muted">üìù {{ r.observaciones }}</small>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. Auto-completado de Fecha y Hora al cargar la p√°gina
    window.onload = function() {
        const ahora = new Date();
        document.getElementById('f_auto').value = ahora.toISOString().split('T')[0];
        document.getElementById('h_auto').value = ahora.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    }

    // 2. L√≥gica del Gr√°fico
    // Extraemos datos de las variables enviadas por Flask
    const fechas = [{% for r in registros|reverse %}"{{ r.fecha }}"{% if not loop.last %}, {% endif %}{% endfor %}];
    const datosIzq = [{% for r in registros|reverse %}{{ r.cant_izq }}{% if not loop.last %}, {% endif %}{% endfor %}];
    const datosDer = [{% for r in registros|reverse %}{{ r.cant_der }}{% if not loop.last %}, {% endif %}{% endfor %}];

    const ctx = document.getElementById('graficoDrenaje').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: fechas,
            datasets: [
                {
                    label: 'Izq (ml)',
                    data: datosIzq,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Der (ml)',
                    data: datosDer,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    title: { display: true, text: 'Mililitros (ml)' }
                }
            }
        }
    });
</script>

</body>
</html>