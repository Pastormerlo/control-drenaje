<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salud - Mauro</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f4f7f6; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .seccion-oculta { display: none; }
        canvas { max-height: 280px; }
        .table-sm td, .table-sm th { font-size: 0.85rem; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">Control de Salud</span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Salir</a>
    </div>
</nav>

<div class="container">
    <div class="btn-group w-100 mb-4">
        <a href="{{ url_for('cargar_registro') }}" class="btn btn-primary">Cargar Datos</a>
        <a href="{{ url_for('ver_registros') }}" class="btn btn-outline-primary">Historial y Gr√°ficos</a>
    </div>

    {% if modo == 'cargar' %}
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card p-4">
                <h4 class="text-center mb-3">Nuevo Registro</h4>
                {% if success %}<div class="alert alert-success">{{ success }}</div>{% endif %}
                <form action="{{ url_for('cargar_registro') }}" method="POST">
                    <div class="row g-3">
                        <div class="col-6"><label>Fecha</label><input type="date" name="fecha" class="form-control" required></div>
                        <div class="col-6"><label>Hora</label><input type="time" name="hora" class="form-control" required></div>
                        <div class="col-12">
                            <select class="form-select form-select-lg" id="tipo_registro" name="tipo_registro" onchange="mostrarCampos()">
                                <option value="drenaje">üíß Drenaje</option>
                                <option value="presion">‚ù§Ô∏è Presi√≥n Arterial</option>
                                <option value="glucosa">ü©∏ Glucosa</option>
                            </select>
                        </div>
                        <div id="campos_drenaje" class="row g-3 mt-1">
                            <div class="col-6"><label>Izq (ml)</label><input type="number" step="0.1" name="cantidad_izq" class="form-control"></div>
                            <div class="col-6"><label>Der (ml)</label><input type="number" step="0.1" name="cantidad_der" class="form-control"></div>
                        </div>
                        <div id="campos_presion" class="row g-3 mt-1 seccion-oculta">
                            <div class="col-4"><label>Alta</label><input type="number" name="presion_alta" class="form-control"></div>
                            <div class="col-4"><label>Baja</label><input type="number" name="presion_baja" class="form-control"></div>
                            <div class="col-4"><label>Pulso</label><input type="number" name="pulso" class="form-control"></div>
                        </div>
                        <div id="campos_glucosa" class="row g-3 mt-1 seccion-oculta">
                            <div class="col-12"><label>Glucosa (mg/dL)</label><input type="number" name="glucosa" class="form-control"></div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 mt-4 fw-bold">GUARDAR REGISTRO</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if modo == 'ver' %}
    <div class="row">
        <div class="col-12">
            <div class="card p-3">
                <h6 class="text-center text-primary">Evoluci√≥n de Drenaje (ml)</h6>
                <canvas id="chartDrenaje"></canvas>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-3">
                <h6 class="text-center text-danger">Presi√≥n Arterial y Pulso</h6>
                <canvas id="chartPresion"></canvas>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-3">
                <h6 class="text-center text-success">Niveles de Glucosa</h6>
                <canvas id="chartGlucosa"></canvas>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-2">
                <h6 class="text-center p-2">Historial de Registros</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover bg-white">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha</th>
                                <th>Datos</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in registros %}
                            <tr>
                                <td><small>{{ r.fecha }}</small></td>
                                <td>
                                    {% if r.cant_izq or r.cant_der %}
                                        I:{{ r.cant_izq or 0 }} | D:{{ r.cant_der or 0 }}
                                    {% elif r.presion_alta %}
                                        {{ r.presion_alta }}/{{ r.presion_baja }} <small>(P:{{ r.pulso }})</small>
                                    {% else %}
                                        {{ r.glucosa }} mg/dL
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('borrar', id=r.id) }}" class="btn btn-link btn-sm text-danger p-0" onclick="return confirm('¬øEst√°s seguro de borrar este registro?');">üóëÔ∏è</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const configBase = { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        };

        // --- DRENAJE ---
        new Chart(document.getElementById('chartDrenaje'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.cant_izq or r.cant_der %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Izq', data: [{% for r in registros|reverse %}{% if r.cant_izq or r.cant_der %}{{r.cant_izq or 0}},{% endif %}{% endfor %}], borderColor: '#0d6efd', tension: 0.3 },
                    { label: 'Der', data: [{% for r in registros|reverse %}{% if r.cant_izq or r.cant_der %}{{r.cant_der or 0}},{% endif %}{% endfor %}], borderColor: '#6c757d', tension: 0.3 }
                ]
            }, options: configBase
        });

        // --- PRESI√ìN Y PULSO (Doble Eje) ---
        new Chart(document.getElementById('chartPresion'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.presion_alta %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [
                    { label: 'Alta', data: [{% for r in registros|reverse %}{% if r.presion_alta %}{{r.presion_alta}},{% endif %}{% endfor %}], borderColor: '#dc3545', yAxisID: 'y' },
                    { label: 'Baja', data: [{% for r in registros|reverse %}{% if r.presion_baja %}{{r.presion_baja}},{% endif %}{% endfor %}], borderColor: '#0d6efd', yAxisID: 'y' },
                    { label: 'Pulso', data: [{% for r in registros|reverse %}{% if r.pulso %}{{r.pulso}},{% endif %}{% endfor %}], borderColor: '#ffc107', borderDash: [5,5], yAxisID: 'y1' }
                ]
            },
            options: {
                ...configBase,
                scales: {
                    y: { type: 'linear', position: 'left', title: { display: true, text: 'Presi√≥n' } },
                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'Pulso' }, grid: { drawOnChartArea: false } }
                }
            }
        });

        // --- GLUCOSA ---
        new Chart(document.getElementById('chartGlucosa'), {
            type: 'line',
            data: {
                labels: [{% for r in registros|reverse %}{% if r.glucosa %}"{{r.fecha}}",{% endif %}{% endfor %}],
                datasets: [{ label: 'Glucosa', data: [{% for r in registros|reverse %}{% if r.glucosa %}{{r.glucosa}},{% endif %}{% endfor %}], borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', fill: true, tension: 0.3 }]
            }, options: configBase
        });
    </script>
    {% endif %}
</div>

<script>
    function mostrarCampos() {
        const tipo = document.getElementById('tipo_registro').value;
        document.getElementById('campos_drenaje').classList.toggle('seccion-oculta', tipo !== 'drenaje');
        document.getElementById('campos_presion').classList.toggle('seccion-oculta', tipo !== 'presion');
        document.getElementById('campos_glucosa').classList.toggle('seccion-oculta', tipo !== 'glucosa');
    }
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/static/sw.js'); }
</script>
</body>
</html>